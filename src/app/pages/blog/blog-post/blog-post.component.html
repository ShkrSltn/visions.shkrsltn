<app-toast></app-toast>
<div class="blog-post-container container">
  @if (loading) {
    <div class="loading-state">
      <p>Loading...</p>
    </div>
  } @else if (notFound) {
    <div class="not-found-state">
      <h1>Post not found</h1>
      <p>The blog post you're looking for doesn't exist or isn't available in your language.</p>
      <a routerLink="/blog" class="back-link">&larr; Back to Blog</a>
    </div>
  } @else if (isAdmin && fullPost) {
    <!-- ═══════════════════════════════════════════ -->
    <!-- ADMIN: Inline editing mode                  -->
    <!-- ═══════════════════════════════════════════ -->

    <!-- Admin toolbar -->
    @if (showToolbar) {
      <div class="admin-toolbar">
        <div class="toolbar-left">
          <a routerLink="/blog" class="toolbar-back">&larr;</a>
          <div class="toolbar-slug">
            <label>slug:</label>
            <input type="text" [(ngModel)]="fullPost.slug" (blur)="saveMetadata()" />
          </div>
          <div class="toolbar-cover">
            <label>cover:</label>
            <input type="text" [(ngModel)]="fullPost.coverImageUrl" placeholder="https://..." (blur)="saveMetadata()" />
          </div>
        </div>
        <div class="toolbar-right">
          <div class="undo-redo-group">
            <button class="toolbar-icon-btn" (click)="undo()" [disabled]="undoStack.length === 0" title="Undo (Ctrl+Z)">
              <i class="fa-solid fa-rotate-left"></i>
            </button>
            <button class="toolbar-icon-btn" (click)="redo()" [disabled]="redoStack.length === 0" title="Redo (Ctrl+Shift+Z)">
              <i class="fa-solid fa-rotate-right"></i>
            </button>
          </div>
          <button
            class="toolbar-btn preview-btn"
            [class.active]="previewMode"
            (click)="togglePreview()"
          >
            <i class="fa-solid" [class.fa-desktop]="!previewMode" [class.fa-pen]="previewMode"></i>
            {{ previewMode ? 'Edit' : 'Preview' }}
          </button>
          <button
            class="toolbar-btn"
            [class.published]="fullPost.isPublished"
            (click)="togglePublish()"
          >
            <i class="fa-solid" [class.fa-eye]="fullPost.isPublished" [class.fa-eye-slash]="!fullPost.isPublished"></i>
            {{ fullPost.isPublished ? 'Published' : 'Draft' }}
          </button>
          <button
            class="toolbar-btn save-btn"
            (click)="saveTranslation()"
            [disabled]="saving"
          >
            <i class="fa-solid fa-floppy-disk"></i>
            {{ saving ? 'Saving...' : 'Save' }}
          </button>
        </div>
      </div>
    }

    @if (!previewMode) {
      <!-- Language tabs -->
      @if (languages.length > 0) {
        <div class="lang-tabs">
          @for (lang of languages; track lang.id) {
            <button
              class="lang-tab"
              [class.active]="activeLanguageId === lang.id"
              (click)="switchLanguage(lang.id)"
            >
              {{ lang.code | uppercase }}
              @if (translationMap[lang.id]?.isVisible) {
                <span class="lang-dot active"></span>
              } @else {
                <span class="lang-dot"></span>
              }
            </button>
          }
          @if (activeLanguageId && translationMap[activeLanguageId]) {
            <label class="visibility-toggle">
              <input
                type="checkbox"
                [(ngModel)]="translationMap[activeLanguageId].isVisible"
              />
              Visible
            </label>
          }
        </div>
      }

      <!-- Cover image -->
      @if (fullPost.coverImageUrl) {
        <div class="cover-image">
          <img [src]="fullPost.coverImageUrl" [alt]="currentTranslation?.title" />
        </div>
      }

      <!-- Editable title & description -->
      @if (currentTranslation) {
        <header class="post-header">
          <h1 class="post-title" [(ceModel)]="currentTranslation.title" data-placeholder="Post title..." (keydown.enter)="$event.preventDefault()"></h1>
          <p class="post-description" [(ceModel)]="currentTranslation.description" data-placeholder="Short description..."></p>
        </header>

        <!-- Block editor -->
        <article class="post-content">
          <div
            class="blocks-editor"
            cdkDropList
            (cdkDropListDropped)="onBlockDrop($event)"
          >
            @for (block of currentBlocks; track trackByIndex($index); let i = $index) {
              <div class="edit-block" cdkDrag>
                <!-- Drag handle + type bar -->
                <div class="edit-block-bar">
                  <span class="drag-handle" cdkDragHandle>
                    <i class="fa-solid fa-grip-vertical"></i>
                  </span>
                  <i class="fa-solid {{ getBlockIcon(block.type) }} block-type-icon"></i>
                  <span class="block-type-name">{{ getBlockLabel(block.type) }}</span>

                  <!-- Inline controls per type -->
                  @if (block.type === 'heading') {
                    <div class="inline-ctrls">
                      @for (lvl of [1, 2, 3]; track lvl) {
                        <button
                          class="ctrl-btn"
                          [class.active]="block.metadata['level'] === lvl"
                          (click)="block.metadata['level'] = lvl"
                        >H{{ lvl }}</button>
                      }
                    </div>
                  }
                  @if (block.type === 'list') {
                    <div class="inline-ctrls">
                      <button class="ctrl-btn" [class.active]="block.metadata['style'] === 'unordered'" (click)="block.metadata['style'] = 'unordered'">
                        <i class="fa-solid fa-list-ul"></i>
                      </button>
                      <button class="ctrl-btn" [class.active]="block.metadata['style'] === 'ordered'" (click)="block.metadata['style'] = 'ordered'">
                        <i class="fa-solid fa-list-ol"></i>
                      </button>
                    </div>
                  }
                  @if (block.type === 'code') {
                    <select class="code-select" [(ngModel)]="block.metadata['language']">
                      @for (lang of codeLanguages; track lang) {
                        <option [value]="lang">{{ lang }}</option>
                      }
                    </select>
                  }
                  @if (block.type === 'callout') {
                    <div class="inline-ctrls">
                      @for (ct of ['info', 'warning', 'success', 'error']; track ct) {
                        <button
                          class="ctrl-btn"
                          [class.active]="block.metadata['type'] === ct"
                          (click)="block.metadata['type'] = ct"
                        >{{ ct }}</button>
                      }
                    </div>
                  }

                  <div class="block-actions">
                    <button class="act-btn" (click)="moveBlockUp(i)" [disabled]="i === 0"><i class="fa-solid fa-chevron-up"></i></button>
                    <button class="act-btn" (click)="moveBlockDown(i)" [disabled]="i === currentBlocks.length - 1"><i class="fa-solid fa-chevron-down"></i></button>
                    <button class="act-btn" (click)="duplicateBlock(i)"><i class="fa-solid fa-copy"></i></button>
                    <button class="act-btn danger" (click)="removeBlock(i)"><i class="fa-solid fa-trash"></i></button>
                  </div>
                </div>

                <!-- Block editing area (same elements as preview, but contenteditable) -->
                <div class="edit-block-body">
                  @switch (block.type) {
                    @case ('heading') {
                      @switch (block.metadata['level']) {
                        @case (1) { <h1 class="block-heading h1" [(ceModel)]="block.content" data-placeholder="Heading..." (keydown.enter)="$event.preventDefault()"></h1> }
                        @case (2) { <h2 class="block-heading h2" [(ceModel)]="block.content" data-placeholder="Heading..." (keydown.enter)="$event.preventDefault()"></h2> }
                        @case (3) { <h3 class="block-heading h3" [(ceModel)]="block.content" data-placeholder="Heading..." (keydown.enter)="$event.preventDefault()"></h3> }
                        @default { <h2 class="block-heading h2" [(ceModel)]="block.content" data-placeholder="Heading..." (keydown.enter)="$event.preventDefault()"></h2> }
                      }
                    }
                    @case ('paragraph') {
                      <p class="block-paragraph" [(ceModel)]="block.content" data-placeholder="Write something..."></p>
                    }
                    @case ('list') {
                      <div class="block-list-edit" [(ceModel)]="block.content" data-placeholder="One item per line..."></div>
                    }
                    @case ('quote') {
                      <blockquote class="block-quote">
                        <p [(ceModel)]="block.content" data-placeholder="Quote..."></p>
                      </blockquote>
                    }
                    @case ('divider') {
                      <hr class="block-divider" />
                    }
                    @case ('code') {
                      <div class="block-code">
                        @if (block.metadata['language']) {
                          <span class="code-lang-label">{{ block.metadata['language'] }}</span>
                        }
                        <pre><code [(ceModel)]="block.content" data-placeholder="// Code..." spellcheck="false" (keydown.tab)="onCodeTab($event)"></code></pre>
                      </div>
                    }
                    @case ('image') {
                      <div class="image-edit-form">
                        <input type="text" [(ngModel)]="block.metadata['url']" placeholder="Image URL..." />
                        <input type="text" [(ngModel)]="block.metadata['caption']" placeholder="Caption..." />
                        @if (block.metadata['url']) {
                          <img [src]="block.metadata['url']" alt="preview" class="image-edit-preview" />
                        }
                      </div>
                    }
                    @case ('callout') {
                      <div class="block-callout" [attr.data-type]="block.metadata['type'] || 'info'">
                        <div class="callout-icon">
                          @switch (block.metadata['type']) {
                            @case ('warning') { <i class="fa-solid fa-triangle-exclamation"></i> }
                            @case ('success') { <i class="fa-solid fa-circle-check"></i> }
                            @case ('error') { <i class="fa-solid fa-circle-xmark"></i> }
                            @default { <i class="fa-solid fa-circle-info"></i> }
                          }
                        </div>
                        <p class="callout-text" [(ceModel)]="block.content" data-placeholder="Callout text..."></p>
                      </div>
                    }
                    @case ('toggle') {
                      <div class="block-toggle expanded">
                        <div class="toggle-summary-bar">
                          <i class="fa-solid fa-caret-right toggle-arrow"></i>
                          <span class="toggle-summary-text" [(ceModel)]="block.metadata['summary']" data-placeholder="Summary..." (keydown.enter)="$event.preventDefault()"></span>
                        </div>
                        <div class="toggle-content">
                          <p [(ceModel)]="block.content" data-placeholder="Hidden content..."></p>
                        </div>
                      </div>
                    }
                  }
                </div>
              </div>

              <!-- Add block between -->
              <div class="add-between" (click)="openBlockPicker(i + 1)">
                <div class="add-line"></div>
                <button class="add-circle"><i class="fa-solid fa-plus"></i></button>
                <div class="add-line"></div>
              </div>
            }
          </div>

          <!-- Add block at bottom -->
          @if (currentBlocks.length === 0) {
            <div class="empty-blocks">
              <p>No content blocks yet. Add your first one!</p>
            </div>
          }
          <button class="add-block-full" (click)="openBlockPicker(currentBlocks.length)">
            <i class="fa-solid fa-plus"></i> Add Block
          </button>
        </article>
      }
    } @else {
      <!-- ═══════════════════════════════════════════ -->
      <!-- ADMIN: Preview mode (guest-like view)       -->
      <!-- ═══════════════════════════════════════════ -->

      <div class="preview-banner">
        <i class="fa-solid fa-desktop"></i>
        Preview Mode — This is how visitors will see this post
      </div>

      @if (fullPost.coverImageUrl) {
        <div class="cover-image">
          <img [src]="fullPost.coverImageUrl" [alt]="previewTitle" />
        </div>
      }

      <header class="post-header">
        <span class="post-date">{{ (fullPost.publishedAt || fullPost.createdAt) | appDateFormat }}</span>
        <h1 class="post-title">{{ previewTitle }}</h1>
        @if (previewDescription) {
          <p class="post-description">{{ previewDescription }}</p>
        }
      </header>

      <article class="post-content">
        @for (block of previewBlocks; track trackByIndex($index); let i = $index) {
          @switch (block.type) {
            @case ('heading') {
              @switch (block.metadata?.['level']) {
                @case (1) { <h1 class="block-heading h1">{{ block.content }}</h1> }
                @case (2) { <h2 class="block-heading h2">{{ block.content }}</h2> }
                @case (3) { <h3 class="block-heading h3">{{ block.content }}</h3> }
                @default { <h2 class="block-heading h2">{{ block.content }}</h2> }
              }
            }
            @case ('paragraph') {
              <p class="block-paragraph">{{ block.content }}</p>
            }
            @case ('list') {
              @if (block.metadata?.['style'] === 'ordered') {
                <ol class="block-list ordered">
                  @for (item of getListItems(block.content); track item) { <li>{{ item }}</li> }
                </ol>
              } @else {
                <ul class="block-list unordered">
                  @for (item of getListItems(block.content); track item) { <li>{{ item }}</li> }
                </ul>
              }
            }
            @case ('quote') {
              <blockquote class="block-quote"><p>{{ block.content }}</p></blockquote>
            }
            @case ('divider') {
              <hr class="block-divider" />
            }
            @case ('code') {
              <div class="block-code">
                @if (block.metadata?.['language']) {
                  <span class="code-lang-label">{{ block.metadata['language'] }}</span>
                }
                <pre><code>{{ block.content }}</code></pre>
              </div>
            }
            @case ('image') {
              <figure class="block-image">
                @if (block.metadata?.['url']) {
                  <img [src]="block.metadata['url']" [alt]="block.metadata?.['caption'] || 'Blog image'" />
                }
                @if (block.metadata?.['caption']) {
                  <figcaption>{{ block.metadata['caption'] }}</figcaption>
                }
              </figure>
            }
            @case ('callout') {
              <div class="block-callout" [attr.data-type]="block.metadata?.['type'] || 'info'">
                <div class="callout-icon">
                  @switch (block.metadata?.['type']) {
                    @case ('warning') { <i class="fa-solid fa-triangle-exclamation"></i> }
                    @case ('success') { <i class="fa-solid fa-circle-check"></i> }
                    @case ('error') { <i class="fa-solid fa-circle-xmark"></i> }
                    @default { <i class="fa-solid fa-circle-info"></i> }
                  }
                </div>
                <p class="callout-text">{{ block.content }}</p>
              </div>
            }
            @case ('toggle') {
              <div class="block-toggle" [class.expanded]="isToggleExpanded(i)">
                <button class="toggle-summary" (click)="toggleExpand(i)">
                  <i class="fa-solid fa-caret-right toggle-arrow"></i>
                  <span>{{ block.metadata?.['summary'] || 'Details' }}</span>
                </button>
                @if (isToggleExpanded(i)) {
                  <div class="toggle-content"><p>{{ block.content }}</p></div>
                }
              </div>
            }
          }
        }
      </article>
    }

  } @else if (post) {
    <!-- ═══════════════════════════════════════════ -->
    <!-- GUEST: Read-only view                       -->
    <!-- ═══════════════════════════════════════════ -->

    <a routerLink="/blog" class="back-link">&larr; Back to Blog</a>

    @if (post.coverImageUrl) {
      <div class="cover-image">
        <img [src]="post.coverImageUrl" [alt]="title" />
      </div>
    }

    <header class="post-header">
      <span class="post-date">{{ (post.publishedAt || post.createdAt) | appDateFormat }}</span>
      <h1 class="post-title">{{ title }}</h1>
      @if (description) {
        <p class="post-description">{{ description }}</p>
      }
    </header>

    <article class="post-content">
      @for (block of blocks; track block.id; let i = $index) {
        @switch (block.type) {
          @case ('heading') {
            @switch (block.metadata?.['level']) {
              @case (1) { <h1 class="block-heading h1">{{ block.content }}</h1> }
              @case (2) { <h2 class="block-heading h2">{{ block.content }}</h2> }
              @case (3) { <h3 class="block-heading h3">{{ block.content }}</h3> }
              @default { <h2 class="block-heading h2">{{ block.content }}</h2> }
            }
          }
          @case ('paragraph') {
            <p class="block-paragraph">{{ block.content }}</p>
          }
          @case ('list') {
            @if (block.metadata?.['style'] === 'ordered') {
              <ol class="block-list ordered">
                @for (item of getListItems(block.content); track item) { <li>{{ item }}</li> }
              </ol>
            } @else {
              <ul class="block-list unordered">
                @for (item of getListItems(block.content); track item) { <li>{{ item }}</li> }
              </ul>
            }
          }
          @case ('quote') {
            <blockquote class="block-quote"><p>{{ block.content }}</p></blockquote>
          }
          @case ('divider') {
            <hr class="block-divider" />
          }
          @case ('code') {
            <div class="block-code">
              @if (block.metadata?.['language']) {
                <span class="code-lang-label">{{ block.metadata['language'] }}</span>
              }
              <pre><code>{{ block.content }}</code></pre>
            </div>
          }
          @case ('image') {
            <figure class="block-image">
              <img [src]="block.metadata?.['url']" [alt]="block.metadata?.['caption'] || 'Blog image'" />
              @if (block.metadata?.['caption']) {
                <figcaption>{{ block.metadata['caption'] }}</figcaption>
              }
            </figure>
          }
          @case ('callout') {
            <div class="block-callout" [attr.data-type]="block.metadata?.['type'] || 'info'">
              <div class="callout-icon">
                @switch (block.metadata?.['type']) {
                  @case ('warning') { <i class="fa-solid fa-triangle-exclamation"></i> }
                  @case ('success') { <i class="fa-solid fa-circle-check"></i> }
                  @case ('error') { <i class="fa-solid fa-circle-xmark"></i> }
                  @default { <i class="fa-solid fa-circle-info"></i> }
                }
              </div>
              <p class="callout-text">{{ block.content }}</p>
            </div>
          }
          @case ('toggle') {
            <div class="block-toggle" [class.expanded]="isToggleExpanded(i)">
              <button class="toggle-summary" (click)="toggleExpand(i)">
                <i class="fa-solid fa-caret-right toggle-arrow"></i>
                <span>{{ block.metadata?.['summary'] || 'Details' }}</span>
              </button>
              @if (isToggleExpanded(i)) {
                <div class="toggle-content"><p>{{ block.content }}</p></div>
              }
            </div>
          }
        }
      }
    </article>

    <div class="post-footer">
      <a routerLink="/blog" class="back-link">&larr; Back to Blog</a>
    </div>
  }
</div>

<!-- Block type picker modal -->
@if (showBlockPicker) {
  <div class="picker-overlay" (click)="closeBlockPicker()">
    <div class="picker-modal" (click)="$event.stopPropagation()">
      <div class="picker-header">
        <h3>Add Block</h3>
        <button class="picker-close" (click)="closeBlockPicker()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="picker-grid">
        @for (bt of blockTypes; track bt.type) {
          <button class="picker-item" (click)="selectBlockType(bt.type)">
            <i class="fa-solid {{ bt.icon }}"></i>
            <span>{{ bt.label }}</span>
          </button>
        }
      </div>
    </div>
  </div>
}
